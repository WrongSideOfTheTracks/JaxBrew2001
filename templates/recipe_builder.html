{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1>Recipe Builder – Hops & IBUs</h1>

    <form method="post" action="/recipe-builder" class="mt-3">
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="batch_volume_l" class="form-label">Batch volume (L)</label>
                <input type="number" step="0.1" min="1"
                       class="form-control"
                       id="batch_volume_l"
                       name="batch_volume_l"
                       value="{{ form.batch_volume_l or '20' }}">
            </div>
            <div class="col-md-3">
                <label for="original_gravity" class="form-label">Original gravity</label>
                <input type="text"
                       class="form-control"
                       id="original_gravity"
                       name="original_gravity"
                       placeholder="e.g. 1.050"
                       value="{{ form.original_gravity or '1.050' }}">
            </div>
        </div>

        <hr>

        <!-- Bittering addition -->
        <h4>Bittering addition</h4>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" value="1" id="use_bittering" name="use_bittering" checked>
            <label class="form-check-label" for="use_bittering">
                Include bittering addition
            </label>
        </div>

        <div class="row mb-3">
            <div class="col-md-5">
                <label class="form-label" for="bittering_hop_id">Hop</label>
                <select class="form-select" id="bittering_hop_id" name="bittering_hop_id">
                    <option value="">-- choose hop --</option>
                    {% for hop in hops %}
                        <option value="{{ hop.id }}"
                            {% if form.bittering_hop_id and form.bittering_hop_id|int == hop.id %}selected{% endif %}>
                            {{ hop.name }}{% if hop.alpha_acid is not none %} ({{ "%.1f"|format(hop.alpha_acid) }}% AA){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="bittering_weight_g">Weight (g)</label>
                <input type="number" step="0.1" min="0"
                       class="form-control"
                       id="bittering_weight_g"
                       name="bittering_weight_g"
                       value="{{ form.bittering_weight_g or '25' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label" for="bittering_time_min">Boil time (min)</label>
                <input type="number" step="1" min="1"
                       class="form-control"
                       id="bittering_time_min"
                       name="bittering_time_min"
                       value="{{ form.bittering_time_min or '60' }}">
            </div>
        </div>

        <hr>

        <!-- Late addition -->
        <h4>Late addition</h4>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" value="1" id="use_late" name="use_late">
            <label class="form-check-label" for="use_late">
                Include late/flavour addition
            </label>
        </div>

        <div class="row mb-3">
            <div class="col-md-5">
                <label class="form-label" for="late_hop_id">Hop</label>
                <select class="form-select" id="late_hop_id" name="late_hop_id">
                    <option value="">-- choose hop --</option>
                    {% for hop in hops %}
                        <option value="{{ hop.id }}"
                            {% if form.late_hop_id and form.late_hop_id|int == hop.id %}selected{% endif %}>
                            {{ hop.name }}{% if hop.alpha_acid is not none %} ({{ "%.1f"|format(hop.alpha_acid) }}% AA){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="late_weight_g">Weight (g)</label>
                <input type="number" step="0.1" min="0"
                       class="form-control"
                       id="late_weight_g"
                       name="late_weight_g"
                       value="{{ form.late_weight_g or '' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label" for="late_time_min">Boil time (min)</label>
                <input type="number" step="1" min="0"
                       class="form-control"
                       id="late_time_min"
                       name="late_time_min"
                       value="{{ form.late_time_min or '15' }}">
            </div>
        </div>

        <hr>

        <!-- Dry hop -->
        <h4>Dry hop</h4>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" value="1" id="use_dry" name="use_dry">
            <label class="form-check-label" for="use_dry">
                Include dry hop (no IBUs calculated)
            </label>
        </div>

        <div class="row mb-4">
            <div class="col-md-5">
                <label class="form-label" for="dry_hop_id">Hop</label>
                <select class="form-select" id="dry_hop_id" name="dry_hop_id">
                    <option value="">-- choose hop --</option>
                    {% for hop in hops %}
                        <option value="{{ hop.id }}"
                            {% if form.dry_hop_id and form.dry_hop_id|int == hop.id %}selected{% endif %}>
                            {{ hop.name }}{% if hop.alpha_acid is not none %} ({{ "%.1f"|format(hop.alpha_acid) }}% AA){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="dry_weight_g">Weight (g)</label>
                <input type="number" step="0.1" min="0"
                       class="form-control"
                       id="dry_weight_g"
                       name="dry_weight_g"
                       value="{{ form.dry_weight_g or '' }}">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Calculate IBUs</button>
    </form>

    {% if result %}
        <hr>
        {% if result.error %}
            <div class="alert alert-danger mt-3">
                {{ result.error }}
            </div>
        {% else %}
            <div class="alert alert-info mt-3">
                <h4>Total IBUs: {{ result.total_ibu }}</h4>
                <ul class="mb-0">
                    {% for add in result.additions %}
                        <li>
                            <strong>{{ add.label }}</strong> –
                            {{ add.hop_name }}
                            {% if add.alpha_acid is not none %}
                                ({{ "%.1f"|format(add.alpha_acid) }}% AA)
                            {% endif %}
                            : {{ add.weight_g }} g @ {{ add.time_display }}
                            {% if add.ibu %}
                                → ~{{ "%.1f"|format(add.ibu) }} IBU
                            {% endif %}
                            {% if add.note %}
                                – <em>{{ add.note }}</em>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}
